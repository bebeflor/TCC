<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fazer Pedido - Vitaliz</title>
  <link rel="stylesheet" href="pedido.css">
</head>
<body>
  <header>
    <h1 class="logo">Vitaliz</h1>
    <nav>
      <a href="cadastro.html">Cadastro</a>
      <a href="inicio.html">Início</a>
      <a href="oculos-fem.html">Moda Feminina</a>
      <a href="oculos-masc.html">Moda Masculina</a>
      <a href="oculos-infantil.html">Moda Infantil</a>
      <a href="consulta.html">Exame de vista</a>
      <a href="relogios.html">Relógios</a>
      <a href="contato.html">Contato</a>
    </nav>
  </header>

  <main>
    <section class="produtos">
      <h2>Fazer Pedido</h2>

      <div class="form-container">
        <form id="pedidoForm">
          <div class="form-grid">
            <div>
              <label for="nome">Nome completo</label>
              <input type="text" id="nome" name="nome" required />
            </div>

            <div>
              <label for="telefone">Número de telefone</label>
              <input type="tel" id="telefone" name="telefone" required />
            </div>

            <div>
              <label for="documento">Documento (CPF ou RG)</label>
              <input type="text" id="documento" name="documento" required />
            </div>

            <div>
              <label for="tipoPagamento">Tipo de pagamento</label>
              <select id="tipoPagamento" name="tipoPagamento" required>
                <option value="">Selecione...</option>
                <option value="cartao">Cartão de crédito</option>
                <option value="boleto">Boleto</option>
                <option value="pix">PIX</option>
                <option value="dinheiro">Dinheiro</option>
              </select>
            </div>

            <!-- parcelas: aparece apenas para cartão ou boleto -->
            <div id="parcelasDiv" style="display:none;">
              <label for="parcelas">Parcelas (até 6x sem juros)</label>
              <select id="parcelas" name="parcelas">
                <option value="1">1x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="4">4x</option>
                <option value="5">5x</option>
                <option value="6">6x</option>
              </select>
            </div>

            <div style="grid-column: 1 / 3;">
              <label for="endereco">Endereço (opcional)</label>
              <input type="text" id="endereco" name="endereco" />
            </div>

            <div style="grid-column: 3 / 5;">
              <label for="observacoes">Observações</label>
              <textarea id="observacoes" name="observacoes" rows="3"></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="botao">Enviar pedido</button>
            <a href="inicio.html" class="botao" style="background:#999;">Voltar</a>
          </div>
        </form>

        <div id="confirmacao" class="confirmacao hidden">
          <h3>Pedido recebido</h3>
          <p>Obrigado! Seu pedido foi salvo localmente. Em breve entraremos em contato.</p>
          <a href="inicio.html" class="botao">Voltar ao início</a>
        </div>

        <!-- Seção de histórico local de pedidos -->
        <div id="historico" class="historico">
          <h3>Meus pedidos (salvos localmente)</h3>
          <div id="historicoList">Nenhum pedido salvo localmente.</div>
          <div style="margin-top:12px;">
            <button id="syncBtn" class="botao" type="button">Sincronizar pedidos salvos</button>
            <button id="clearLocalBtn" class="botao" type="button" style="background:#999;margin-left:8px;">Limpar histórico</button>
          </div>
        </div>

      </div>

    </section>
  </main>

  <footer>
    © 2025 Ótica Vitaliz - Todos os direitos reservados
  </footer>

  <style>
    /* Modal de progresso */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .modal { background: #fff; padding: 24px; border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); max-width: 420px; width: 90%; text-align: center; }
    .spinner { width: 48px; height: 48px; border-radius: 50%; border: 5px solid #eee; border-top-color: #163041; margin: 12px auto; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .historico { margin-top: 22px; border-top: 1px solid #eee; padding-top: 16px; }
    .historico-item { background:#fafafa; padding:10px; border-radius:8px; margin-bottom:8px; font-size:0.95em; }
  </style>

  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div id="modalContent">
        <h3 id="modalTitle">Enviando pedido</h3>
        <div class="spinner" aria-hidden="true"></div>
        <p id="modalMessage">Aguarde enquanto enviamos seu pedido...</p>
      </div>
    </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const historicoList = document.getElementById('historicoList');
    const syncBtn = document.getElementById('syncBtn');
    const clearLocalBtn = document.getElementById('clearLocalBtn');

    function showModal(title, message, showSpinner = true) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalOverlay.style.display = 'flex';
      modalOverlay.setAttribute('aria-hidden', 'false');
      // toggle spinner visibility
      document.querySelector('.spinner').style.display = showSpinner ? 'block' : 'none';
    }

    function hideModal() {
      modalOverlay.style.display = 'none';
      modalOverlay.setAttribute('aria-hidden', 'true');
    }

    function loadLocalPedidos() {
      const arr = JSON.parse(localStorage.getItem('pedidos') || '[]');
      if (!arr.length) {
        historicoList.textContent = 'Nenhum pedido salvo localmente.';
        return;
      }
      historicoList.innerHTML = '';
      arr.slice().reverse().forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'historico-item';
        div.textContent = `${p.data ? new Date(p.data).toLocaleString() + ' - ' : ''}${p.nome} | ${p.telefone} | ${p.observacoes || ''}`;
        historicoList.appendChild(div);
      });
    }

    // sincroniza pedidos salvos localmente com o servidor
    async function syncLocalPedidos() {
      const arr = JSON.parse(localStorage.getItem('pedidos') || '[]');
      if (!arr.length) { alert('Não há pedidos locais para sincronizar.'); return; }
      showModal('Sincronizando', 'Enviando pedidos locais para o servidor...');
      try {
        for (const pedido of arr) {
          await fetch('/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pedido) });
        }
        localStorage.removeItem('pedidos');
        loadLocalPedidos();
        showModal('Sincronizado', 'Todos os pedidos locais foram enviados com sucesso.', false);
        setTimeout(hideModal, 1800);
      } catch (err) {
        console.warn('Falha ao sincronizar:', err);
        showModal('Erro', 'Não foi possível sincronizar todos os pedidos. Verifique a conexão e tente novamente.', false);
        setTimeout(hideModal, 2000);
      }
    }

    syncBtn.addEventListener('click', syncLocalPedidos);
    clearLocalBtn.addEventListener('click', () => { if (confirm('Remover todos os pedidos salvos localmente?')) { localStorage.removeItem('pedidos'); loadLocalPedidos(); } });

    const form = document.getElementById('pedidoForm');
    const confirmacao = document.getElementById('confirmacao');

    // Carrega itens acumulados em sessionStorage/localStorage (se houver)
    function loadPendingItems() {
      try {
        const fromSession = JSON.parse(sessionStorage.getItem('pedido_items') || '[]');
        if (Array.isArray(fromSession) && fromSession.length) return fromSession;
      } catch (e) { /* ignore */ }
      try {
        const fromLocal = JSON.parse(localStorage.getItem('pedido_items') || '[]');
        if (Array.isArray(fromLocal) && fromLocal.length) return fromLocal;
      } catch (e) { /* ignore */ }
      return [];
    }

    // Preenche automático se houver parâmetros ?produto=Nome&preco=R$...
    const params = new URLSearchParams(window.location.search);
    const produto = params.get('produto');
    const preco = params.get('preco');

    // Primeiro aplica o preenchimento por query string (mantendo compatibilidade)
    if (produto) {
      const obs = document.getElementById('observacoes');
      obs.value = `Pedido do produto: ${produto}${preco ? ' - ' + preco : ''}`;
    }

    // Agora anexa todos os itens acumulados (se houver) à área de Observações
    const pendingItems = loadPendingItems();
    if (pendingItems.length) {
      const obs = document.getElementById('observacoes');
      const itemsText = pendingItems.map((it, idx) => {
        const p = it.produto || '';
        const pr = it.preco || '';
        return `${idx + 1}) ${p}${pr ? ' - ' + pr : ''}`;
      }).join('; ');

      const prefix = `Itens adicionados: ${itemsText}`;
      if (obs.value && obs.value.trim()) {
        obs.value = obs.value.trim() + '\n' + prefix;
      } else {
        obs.value = prefix;
      }

      // Limpa os itens acumulados para não duplicar em próximos acessos
      try { sessionStorage.removeItem('pedido_items'); } catch (e) {}
      try { localStorage.removeItem('pedido_items'); } catch (e) {}
    }

    // inicializa histórico local
    loadLocalPedidos();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const parcelasEl = document.getElementById('parcelas');
      const dados = {
        nome: form.nome.value.trim(),
        telefone: form.telefone.value.trim(),
        documento: form.documento.value.trim(),
        tipoPagamento: form.tipoPagamento.value,
        parcelas: parcelasEl ? parcelasEl.value : '1',
        endereco: form.endereco.value.trim(),
        observacoes: form.observacoes.value.trim(),
        produtoTitulo: produto || null,
        produtoPreco: preco || null,
        data: new Date().toISOString()
      };

      // validação simples
      if (!dados.nome || !dados.telefone || !dados.documento || !dados.tipoPagamento) {
        alert('Preencha os campos obrigatórios.');
        return;
      }

      // Desabilita botão para evitar envios duplicados
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.disabled = true;

      // Tenta enviar ao servidor; se falhar, salva no localStorage como fallback
      try {
        showModal('Enviando pedido', 'Aguarde enquanto enviamos seu pedido...');
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });

        if (!res.ok) throw new Error('Erro no servidor');

        // sucesso
        hideModal();
        form.classList.add('hidden');
        confirmacao.classList.remove('hidden');
      } catch (err) {
        console.warn('Falha ao enviar para o servidor, salvando localmente:', err);
        const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
        pedidos.push(dados);
        localStorage.setItem('pedidos', JSON.stringify(pedidos));
        loadLocalPedidos();

        hideModal();
        showModal('Salvo localmente', 'O pedido foi salvo localmente e pode ser sincronizado mais tarde.', false);
        setTimeout(hideModal, 1500);
        form.classList.add('hidden');
        confirmacao.classList.remove('hidden');
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    });

    // mostra parcelas quando aplicável
    const tipoPagamento = document.getElementById('tipoPagamento');
    const parcelasDiv = document.getElementById('parcelasDiv');
    tipoPagamento.addEventListener('change', (e) => {
      if (e.target.value === 'cartao' || e.target.value === 'boleto') {
        parcelasDiv.style.display = 'block';
      } else {
        parcelasDiv.style.display = 'none';
      }
    });
  });
</script>
</body>
</html>
